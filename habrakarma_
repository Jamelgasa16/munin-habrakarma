#!/bin/bash

plugin_filename="${0##*/}"
username="${plugin_filename#*_}"
#Хабр понимает только логины с подчёркиваниями вместо -
username="${username//-/_}"

if [ "$1" = "config" ]; then
    echo "graph_title KarmaGraph $username
graph_category web 
graph_vlabel #
karma.label Karma
rating.label Rating"
    exit
fi

exec 33<>/dev/tcp/habrahabr.ru/80
printf '%s\r\n' "GET /api/profile/$username/ HTTP/1.0" 'Host: habrahabr.ru' '' >&33
read -t 5 -d '' REPLY <&33

for v in karma rating; do
    [[ $REPLY =~ "<$v>"(.*)"</$v>" ]]
    echo "$v.value ${BASH_REMATCH[1]:-U}"
done
